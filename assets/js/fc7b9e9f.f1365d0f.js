"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4361],{5475:e=>{e.exports=JSON.parse('{"blogPosts":[{"id":"/2022/10/18/vcluster","metadata":{"permalink":"/se7en-documentation/blog/2022/10/18/vcluster","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-10-18-vcluster.md","source":"@site/blog/2022-10-18-vcluster.md","title":"vcluster","description":"1 vcluster \u4ecb\u7ecd","date":"2022-10-18T00:00:00.000Z","formattedDate":"October 18, 2022","tags":[],"readingTime":20.93,"hasTruncateMarker":false,"authors":[],"frontMatter":{},"nextItem":{"title":"Welcome","permalink":"/se7en-documentation/blog/welcome"}},"content":"## 1 vcluster \u4ecb\u7ecd\\n\u865a\u62df\u96c6\u7fa4\uff08virtual cluster, \u7b80\u79f0 vcluster\uff09\u662f\u5728\u5e38\u89c4\u7684 Kubernetes \u96c6\u7fa4\u4e4b\u4e0a\u8fd0\u884c\u7684\u4e00\u4e2a\u529f\u80fd\u9f50\u5168\uff0c\u8f7b\u91cf\u7ea7\uff0c\u9694\u79bb\u6027\u826f\u597d\u7684 Kubernetes \u96c6\u7fa4\u3002\u4e0e\u5b8c\u5168\u72ec\u7acb\u7684\u201c\u771f\u5b9e\u201c\u96c6\u7fa4\u76f8\u6bd4\uff0c\u865a\u62df\u96c6\u7fa4\u6ca1\u6709\u81ea\u5df1\u7684\u8282\u70b9\u6c60\uff0c\u4f46\u662f\u53ef\u4ee5\u5728\u5e95\u5c42\u5bbf\u4e3b\u96c6\u7fa4\u4e0a\u8c03\u5ea6\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u540c\u65f6\u5177\u6709\u81ea\u5df1\u5355\u72ec\u7684\u63a7\u5236\u5e73\u9762\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922222305.png)\\n\\nvcluster \u6709\u4ee5\u4e0b\u7279\u70b9\uff1a\\n- **\u53ef\u4f7f\u7528\u96c6\u7fa4\u5c42\u9762\u7684\u8d44\u6e90**\uff1a\u5728\u865a\u62df\u96c6\u7fa4\u5141\u8bb8\u79df\u6237\u4f7f\u7528 CRD\u3001Namespaces\u3001ClusterRole \u7b49\u8d44\u6e90\uff0c\u8fd9\u6bd4\u901a\u8fc7\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u7684\u65b9\u5f0f\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u3002\\n-   **\u8f7b\u91cf\u7ea7**\uff1avcluster \u9ed8\u8ba4\u4f7f\u7528 k3s \u6784\u5efa\u865a\u62df\u96c6\u7fa4\uff0ck3s \u662f\u4e00\u4e2a\u7ecf\u8fc7\u8ba4\u8bc1\u7684\u8f7b\u91cf\u7ea7 Kubernetes \u53d1\u884c\u7248\uff0c100% \u517c\u5bb9 Kubernetes API\uff0c\u5b83\u5c06 Kubernetes \u7ec4\u4ef6\u7f16\u8bd1\u4e3a\u5c0f\u4e8e 100 MB \u7684\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\uff0c\u9ed8\u8ba4\u7981\u7528\u6240\u6709\u4e0d\u9700\u8981\u7684 Kubernetes \u529f\u80fd\uff0c\u4f8b\u5982 pod \u8c03\u5ea6\u7a0b\u5e8f\u6216\u67d0\u4e9b\u63a7\u5236\u5668\uff0c\u8fd9\u4f7f\u5f97 k3s \u7684\u5185\u5b58\u4f7f\u7528\u4ec5\u4ec5\u4e3a\u5e38\u89c4 k8s \u7684\u4e00\u534a\u3002\u53e6\u5916 vcluster \u8fd8\u652f\u6301\u5176\u4ed6\u53d1\u884c\u7248\uff0c\u4f8b\u5982 k0s \u6216\u5e38\u89c4 k8s\u3002\\n- **\u7ecf\u6d4e\u9ad8\u6548**\uff1a\u521b\u5efa\u865a\u62df\u96c6\u7fa4\u6bd4\u201c\u771f\u6b63\u7684\u201c\u96c6\u7fa4\u66f4\u52a0\u4fbf\u5b9c\u548c\u9ad8\u6548\uff0c\u6700\u5c11\u53ea\u9700\u8981\u521b\u5efa\u5355\u4e2a vcluster pod\uff08\u5305\u542b API server, syncer, \u540e\u7aef\u5b58\u50a8\uff09\u3002\\n- **\u826f\u597d\u7684\u9694\u79bb\u6027**\uff1a\u6bcf\u4e2a\u865a\u62df\u96c6\u7fa4\u6709\u72ec\u7acb\u7684\u63a7\u5236\u9762\uff0c\u53ea\u662f\u5171\u4eab\u4e86\u5e95\u5c42\u5bbf\u4e3b\u96c6\u7fa4\u7684\u8ba1\u7b97\u8d44\u6e90\u7b49\u670d\u52a1\u3002\\n-   **\u6ca1\u6709\u6027\u80fd\u4e0b\u964d**\uff1aPod \u5b9e\u9645\u4e0a\u88ab\u90e8\u7f72\u5728\u5e95\u5c42\u4e3b\u673a\u96c6\u7fa4\u4e2d\uff0c\u56e0\u6b64\u5b83\u4eec\u5728\u8fd0\u884c\u65f6\u6839\u672c\u4e0d\u4f1a\u53d7\u5230\u6027\u80fd\u5f71\u54cd\u3002\\n-   **\u51cf\u5c11\u4e3b\u673a\u96c6\u7fa4\u7684\u5f00\u9500**\uff1a\u5c06\u5927\u578b\u591a\u79df\u6237\u96c6\u7fa4\u62c6\u5206\u4e3a\u66f4\u5c0f\u7684 vcluster\uff0c\u4ee5\u964d\u4f4e\u590d\u6742\u6027\u5e76\u63d0\u9ad8\u53ef\u6269\u5c55\u6027\u3002\u7531\u4e8e\u5927\u591a\u6570 vcluster api \u8bf7\u6c42\u548c\u5bf9\u8c61\u6839\u672c\u4e0d\u4f1a\u5230\u8fbe\u5bbf\u4e3b\u96c6\u7fa4\uff0c\u56e0\u6b64 vcluster \u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u5e95\u5c42 Kubernetes \u96c6\u7fa4\u7684\u538b\u529b\\n-   **\u6613\u4e8e\u90e8\u7f72**\xa0\uff1avcluster \u53ef\u4ee5\u901a\u8fc7 vcluster CLI\u3001helm\u3001kubectl\u3001[cluster api](https://github.com/loft-sh/cluster-api-provider-vcluster)\u3001Argo CD \u7b49\u591a\u79cd\u5de5\u5177\u8fdb\u884c\u90e8\u7f72\uff08\u5b83\u57fa\u672c\u4e0a\u53ea\u662f\u4e00\u4e2a StatefulSet \u8d44\u6e90\uff09\u3002\\n-   **\u5355\u4e00\u547d\u540d\u7a7a\u95f4\u5c01\u88c5**\uff1a\u6bcf\u4e2a vcluster \u53ca\u5176\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u4f4d\u4e8e\u5e95\u5c42\u5bbf\u4e3b\u96c6\u7fa4\u7684\u5355\u4e00\u547d\u540d\u7a7a\u95f4\u5185\u3002\\n-   **\u7075\u6d3b\u548c\u591a\u529f\u80fd**\uff1avcluster \u652f\u6301\u4e0d\u540c\u7684\u540e\u7aef\u5b58\u50a8\uff08\u4f8b\u5982 sqlite\u3001mysql\u3001postgresql \u548c etcd\uff09\u3001\u63d2\u4ef6\u3001\u81ea\u5b9a\u4e49\u8d44\u6e90\u540c\u6b65\u7b56\u7565\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5\u5728 vcluster \u4e2d\u90e8\u7f72 vcluster\u3002\\n\\n\u4f7f\u7528\u865a\u62df\u96c6\u7fa4\u76f8\u6bd4\u521b\u5efa\u5355\u72ec\u7684 Kubernetes \u96c6\u7fa4\u66f4\u7ecf\u6d4e\u9ad8\u6548\uff0c\u76f8\u8f83\u4e8e\u5e38\u89c4\u7684\u547d\u540d\u7a7a\u95f4\u5219\u80fd\u591f\u63d0\u4f9b\u66f4\u597d\u7684\u591a\u79df\u6237\u548c\u9694\u79bb\u7279\u6027\u3002\u4e0b\u8868\u5bf9\u547d\u540d\u7a7a\u95f4\u3001vcluster \u548c Kubernetes \u96c6\u7fa4 3 \u79cd\u65b9\u5f0f\u5728\u9694\u79bb\u6027\u3001\u591a\u79df\u6237\u8bbf\u95ee\u3001\u6210\u672c\u7b49\u65b9\u9762\u8fdb\u884c\u4e86\u5bf9\u6bd4\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221015164752.png)\\n## 2 vcluster \u5feb\u901f\u4e0a\u624b\\n### 2.1 \u51c6\u5907\u6301\u4e45\u5316\u5b58\u50a8\\n\u521b\u5efa vcluster \u9ed8\u8ba4\u9700\u8981\u4f7f\u7528\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5982\u679c\u96c6\u7fa4\u4e0a\u5df2\u7ecf\u914d\u7f6e\u597d\u9ed8\u8ba4\u7684\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u53ef\u4ee5\u8df3\u8fc7\u6b64\u6b65\u9aa4\u3002\\n\\n\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5b89\u88c5 OpenEBS\u3002\\n```bash\\nkubectl apply -f https://openebs.github.io/charts/openebs-operator.yaml\\n```\\n\\n\u8bbe\u7f6e StorageClass openebs-hostpath \u4f5c\u4e3a\u9ed8\u8ba4\u7684 StorageClass\u3002\\n```bash\\nkubectl patch storageclass openebs-hostpath -p \'{\\"metadata\\": {\\"annotations\\":{\\"storageclass.kubernetes.io/is-default-class\\":\\"true\\"}}}\'\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221015173730.png)\\n\\n\u786e\u8ba4 OpenEBS \u5404\u7ec4\u4ef6\u6b63\u5e38\u8fd0\u884c\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922214231.png)\\n\\n### 2.2 \u5b89\u88c5 vcluster CLI\\n\u53c2\u7167 [Install vcluster CLI[1]](https://www.vcluster.com/docs/getting-started/setup) \u6839\u636e\u5bf9\u5e94\u7684\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u8fdb\u884c\u5b89\u88c5\u3002\\n\\n### 2.3 \u521b\u5efa\u865a\u62df\u96c6\u7fa4\\n\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a my-vcluster \u7684\u865a\u62df\u96c6\u7fa4\uff0c\u9ed8\u8ba4\u4f1a\u5728 `vcluster-<vcluster-name>` \uff08\u672c\u4f8b\u4e2d\u662f vcluster-my-vcluster\uff09Namespace \u4e2d\u90e8\u7f72\u865a\u62df\u96c6\u7fa4\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 `-n` \u53c2\u6570\u6307\u5b9a\u90e8\u7f72\u865a\u62df\u96c6\u7fa4\u7684 Namespace\u3002\\n```bash\\nvcluster create my-vcluster\\n```\\n\\n\u865a\u62df\u96c6\u7fa4\u521b\u5efa\u6210\u529f\u540e\uff0cvcluster \u4f1a\u81ea\u52a8\u5e2e\u6211\u4eec\u901a\u8fc7\u7aef\u53e3\u8f6c\u53d1\u8fde\u63a5\u5230\u865a\u62df\u96c6\u7fa4\u3002\u5982\u679c\u4f7f\u7528 kubectl \u6216\u8005 helm \u7684\u65b9\u5f0f\u5b89\u88c5\u865a\u62df\u96c6\u7fa4\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 `vcluster connect <cluster-name>` \u547d\u4ee4\u6765\u624b\u52a8\u8fde\u63a5\u5230\u865a\u62df\u96c6\u7fa4\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922215010.png)\\n\\n\u6253\u5f00\u53e6\u4e00\u4e2a\u7a97\u53e3\u6267\u884c kubectl \u547d\u4ee4\u67e5\u770b Pod \u548c Namespace\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u662f\u4e00\u4e2a\u5168\u65b0\u7684\u96c6\u7fa4\uff0c\u5e76\u4e0d\u80fd\u770b\u5230\u865a\u62df\u96c6\u7fa4\u6240\u5c5e\u7684 vcluster-my-vcluster Namespace\uff0c\u56e0\u4e3a\u8be5 Namespace \u5b58\u5728\u4e8e\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u3002 \\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922215322.png)\\n\\n### 2.4 \u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u8d44\u6e90\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Namespace\uff0c\u5e76\u5728\u91cc\u9762\u90e8\u7f72\u4e00\u4e2a nginx Deployment\u3002\\n```bash\\nkubectl create namespace demo-nginx\\nkubectl create deployment nginx-deployment -n demo-nginx --image=nginx\\n```\\n\\n\u67e5\u770b\u521b\u5efa\u7684 Pod\u3002\\n```bash\\n> kubectl get pod -n demo-nginx\\nNAME                                READY   STATUS    RESTARTS   AGE\\nnginx-deployment-5fbdf85c67-42rmp   1/1     Running   0          13s\\n```\\n\\n\u952e\u76d8\u6309 ctrl + c \u65ad\u5f00\u548c\u865a\u62df\u96c6\u7fa4\u7684\u8fde\u63a5\uff0ckubectl \u7684\u4e0a\u4e0b\u6587\u4f1a\u81ea\u52a8\u5207\u6362\u56de\u5bbf\u4e3b\u96c6\u7fa4\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922220731.png)\\n\\n\\n\u5728\u5bbf\u4e3b\u96c6\u7fa4\u67e5\u770b Namespace\uff0c\u5e76\u6ca1\u6709\u770b\u5230\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684 demo-nginx Namespace\uff0c\u56e0\u4e3a\u8be5 Namespace \u53ea\u5b58\u5728\u4e8e\u865a\u62df\u96c6\u7fa4\u4e2d\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922220954.png)\\n\\n\u540c\u6837\u4e5f\u770b\u4e0d\u5230 nginx-deployment\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922221516.png)\\n\\n\\nPod \u5728\u865a\u62df\u96c6\u7fa4\u6240\u5c5e\u7684 Namespace \u4e2d\u662f\u5b58\u5728\u7684\uff0cvcluster \u4e2d\u6709\u4e00\u4e2a **syncer** \u63a7\u5236\u5668\uff0c\u4e3b\u8981\u8d1f\u8d23\u5c06\u865a\u62df\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u540c\u6b65\u5230\u5e95\u5c42\u5bbf\u4e3b\u96c6\u7fa4\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0cPod \u7684\u5b9e\u9645\u8c03\u5ea6\u8fd8\u662f\u4f9d\u9760\u5bbf\u4e3b\u96c6\u7fa4\u4e0a\u7684\u8c03\u5ea6\u5668\u5b8c\u6210\u7684\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220922221337.png)\\n\\n### 2.5 \u6e05\u7406\u865a\u62df\u96c6\u7fa4\\n\u4f7f\u7528 `vcluster delete` \u547d\u4ee4\u53ef\u4ee5\u5220\u9664\u865a\u62df\u96c6\u7fa4\u3002\\n```bash\\nvcluster delete my-vcluster\\n```\\n## 3 \u66b4\u9732 vcluster\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cvcluster \u53ea\u80fd\u901a\u8fc7\u8fdc\u7a0b\u96c6\u7fa4\u4e2d\u7684\u7aef\u53e3\u8f6c\u53d1\u8fdb\u884c\u8bbf\u95ee\u3002\u8981\u60f3\u76f4\u63a5\u8bbf\u95ee\u865a\u62df\u96c6\u7fa4\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7\u4f7f\u7528 LoadBalancer \u6216\u8005 NodePort \u7c7b\u578b\u7684 Service \u5c06\u865a\u62df\u96c6\u7fa4\u66b4\u9732\u5230\u96c6\u7fa4\u5916\u3002\\n\\n\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u5728\u521b\u5efa\u865a\u62df\u96c6\u7fa4\u7684\u65f6\u5019\u6307\u5b9a `--expose` \u53c2\u6570\uff0cvcluster \u4f1a\u521b\u5efa LoadBalancer \u7c7b\u578b\u7684 Service \u66b4\u9732\u865a\u62df\u96c6\u7fa4\uff08\u524d\u63d0\u8981\u6709\u516c\u6709\u4e91\u6258\u7ba1\u7684 Kubernetes \u96c6\u7fa4\u652f\u6301 LoadBalancer\uff09\u3002\u7b49\u5f85\u865a\u62df\u96c6\u7fa4\u521b\u5efa\u5b8c\u6210\u540e\uff0cvcluster \u4f1a\u81ea\u52a8\u5e2e\u6211\u4eec\u5c06\u865a\u62df\u96c6\u7fa4\u7684 kubeconfig \u914d\u7f6e\u6dfb\u52a0\u5230 ~/.kube/config \u6587\u4ef6\u4e2d\uff0c\u6b64\u65f6\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 kubectl \u547d\u4ee4\u884c\u8bbf\u95ee\u865a\u62df\u96c6\u7fa4\u3002\\n```bash\\nvcluster create my-vcluster --expose\\n```\\n\\n\u4f60\u4e5f\u53ef\u4ee5\u624b\u52a8\u521b\u5efa Service \u6765\u66b4\u9732 vcluster\uff0c\u66f4\u591a\u65b9\u5f0f\u53c2\u89c1 [Exposing vcluster (ingress etc.)](https://www.vcluster.com/docs/operator/external-access)\u3002\\n\\n## 4 \u7f51\u7edc & DNS \u89e3\u6790\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPod \u548c Service \u8d44\u6e90\u90fd\u4f1a\u4ece\u865a\u62df\u96c6\u7fa4\u540c\u6b65\u5230\u4e3b\u673a\u96c6\u7fa4\uff0c\u4ee5\u4fbf\u4e3a vcluster \u542f\u7528\u6b63\u786e\u7684\u7f51\u7edc\u529f\u80fd\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221015190051.png)\\n\\n\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u96c6\u7fa4\u7528\u4e8e\u6d4b\u8bd5\u3002\\n```bash\\nvcluster create net-vcluster\\n```\\n### 4.1 \u901a\u8fc7 IP \u5730\u5740\u901a\u4fe1\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684 Pod \u4f1a\u88ab vcluster \u7684 syncer \u540c\u6b65\u5230\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\uff0c\u56e0\u6b64 Pod \u5b9e\u9645\u4e0a\u8fd0\u884c\u5728\u5e95\u5c42\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u3002\u8fd9\u610f\u5473\u7740\u8fd9\u4e9b Pod \u5177\u6709\u5e38\u89c4\u7684\u96c6\u7fa4\u5185\u90e8 IP \u5730\u5740\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7 IP \u5730\u5740\u76f8\u4e92\u901a\u4fe1\u3002\\n\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Pod\u3002\\n```bash\\nkubectl create deployment nettool-virtual --image=cr7258/nettool:v1\\n```\\n\u5728\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Pod\u3002\uff08\u5728\u5bbf\u4e3b\u96c6\u7fa4 context \u4e2d\u6267\u884c\uff09\\n```bash\\n# \u6253\u5f00\u53e6\u4e00\u4e2a\u7a97\u53e3\uff0c\u5148\u5207\u6362\u5230\u5bbf\u4e3b\u96c6\u7fa4\u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl config get-context \u547d\u4ee4\u5217\u51fa\u4e0a\u4e0b\u6587\\nkubectl config use-context <host-cluster-context>\\nkubectl create deployment nettool-host --image=cr7258/nettool:v1\\n```\\n\\n\u67e5\u770b\u5728\u865a\u62df\u96c6\u7fa4\u548c\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684 Pod \u7684 IP \u5730\u5740\u3002\uff08\u5728\u5bbf\u4e3b\u96c6\u7fa4 context \u4e2d\u6267\u884c\uff09\\n```bash\\nkubectl get pod -o wide\\nkubectl get pod -n vcluster-net-vcluster -o wide\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220923110715.png)\\n\\n\u4e24\u4e2a Pod \u4e4b\u95f4\u4e92\u76f8 Ping \u6d4b\u8bd5\uff0c\u7f51\u7edc\u4e4b\u95f4\u53ef\u4ee5\u4e92\u901a\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220923114034.png)\\n\\n\u865a\u62df\u96c6\u7fa4\u548c\u5bbf\u4e3b\u96c6\u7fa4\u4e4b\u95f4\u7684 Pod \u4ee5\u53ca Service \u8d44\u6e90\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u90fd\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 IP \u5730\u5740\u4e92\u76f8\u8bbf\u95ee\u3002\\n\\n### 4.2 \u901a\u8fc7\u57df\u540d\u901a\u4fe1\\n\u6bcf\u4e2a\u865a\u62df\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u72ec\u7acb\u7684 DNS \u670d\u52a1\uff08CoreDNS\uff09\uff0c\u4e3a\u865a\u62df\u96c6\u7fa4\u4e2d\u7684 Service \u63d0\u4f9b DNS \u89e3\u6790\u3002\\n\\n\u5c06\u865a\u62df\u96c6\u7fa4\u548c\u5bbf\u4e3b\u96c6\u7fa4\u7684 Deployment \u5206\u522b\u901a\u8fc7 Service \u8fdb\u884c\u66b4\u9732\u3002\\n```bash\\nkubectl config use-context <host-cluster-context>\\nkubectl expose deployment nettool-host --port=80 --target-port=80\\n\\nkubectl config use-context <virtual-cluster-context>\\nkubectl expose deployment nettool-virtual --port=80 --target-port=80\\n```\\n### 4.3 \u5c06\u5bbf\u4e3b\u96c6\u7fa4 Service \u6620\u5c04\u5230\u865a\u62df\u96c6\u7fa4\u4e2d\\n\u5c06\u5bbf\u4e3b\u96c6\u7fa4 default Namespace \u4e2d\u7684 nettool-host Service \u6620\u5c04\u5230\u865a\u62df\u96c6\u7fa4\u7684 default Namespace \u4e2d\u7684 nettool-host Service\u3002\\n```yaml\\nmapServices:\\n  fromHost:\\n  - from: default/nettool-host \\n    to: default/nettool-host\\n```\\n```bash\\nvcluster create net-vcluster --upgrade -f host-to-vcluster.yaml\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220923143358.png)\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220925165954.png)\\n\\n\u4f7f\u7528\u865a\u62df\u96c6\u7fa4\u7684 Pod \u8bbf\u95ee\u5bbf\u4e3b\u96c6\u7fa4\u7684 nettool-host Service\u3002\\n```bash\\n> kubectl exec -it deployments/nettool-virtual -- curl nettool-host\\n\\n# \u8fd4\u56de\u7ed3\u679c\\n<!DOCTYPE html>\\n<html>\\n<head>\\n<title>Welcome to nginx!</title>\\n<style>\\nhtml { color-scheme: light dark; }\\nbody { width: 35em; margin: 0 auto;\\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\\n</style>\\n</head>\\n<body>\\n<h1>Welcome to nginx!</h1>\\n<p>If you see this page, the nginx web server is successfully installed and\\nworking. Further configuration is required.</p>\\n\\n<p>For online documentation and support please refer to\\n<a href=\\"http://nginx.org/\\">nginx.org</a>.<br/>\\nCommercial support is available at\\n<a href=\\"http://nginx.com/\\">nginx.com</a>.</p>\\n\\n<p><em>Thank you for using nginx.</em></p>\\n</body>\\n</html>\\n```\\n### 4.4 \u5c06\u865a\u62df\u96c6\u7fa4 Service \u6620\u5c04\u5230\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\\n```bash\\nvcluster create net-vcluster --upgrade -f vcluster-to-host.yaml\\n```\\n\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220925170048.png)\\n\\n\u4f7f\u7528\u5bbf\u4e3b\u96c6\u7fa4\u7684 Pod \u8bbf\u95ee\u865a\u62df\u96c6\u7fa4\u7684 nettool-virtual Service\uff0c\u865a\u62df\u96c6\u7fa4\u4e2d\u7684 Service \u4f1a\u6620\u5c04\u5230\u5bbf\u4e3b\u96c6\u7fa4\u7684 vcluster-net-vcluster Namespace \u4e2d\u3002\\n```bash\\n> kubectl exec -it deployments/nettool-host -- curl nettool-virtual.vcluster-net-vcluster\\n\\n# \u8fd4\u56de\u7ed3\u679c\\n<!DOCTYPE html>\\n<html>\\n<head>\\n<title>Welcome to nginx!</title>\\n<style>\\nhtml { color-scheme: light dark; }\\nbody { width: 35em; margin: 0 auto;\\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\\n</style>\\n</head>\\n<body>\\n<h1>Welcome to nginx!</h1>\\n<p>If you see this page, the nginx web server is successfully installed and\\nworking. Further configuration is required.</p>\\n\\n<p>For online documentation and support please refer to\\n<a href=\\"http://nginx.org/\\">nginx.org</a>.<br/>\\nCommercial support is available at\\n<a href=\\"http://nginx.com/\\">nginx.com</a>.</p>\\n\\n<p><em>Thank you for using nginx.</em></p>\\n</body>\\n</html>\\n```\\n\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n```bash\\nvcluster delete net-vcluster\\n```\\n\\n## 5 \u6682\u505c & \u6062\u590d\u865a\u62df\u96c6\u7fa4\\n\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u96c6\u7fa4\u7528\u4e8e\u6d4b\u8bd5\u3002\\n```bash\\nvcluster create recover-vcluster\\n```\\n\\n\u67e5\u770b\u5f53\u524d\u865a\u62df\u96c6\u7fa4\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff1a\\n- coredns Pod \u4f1a\u901a\u8fc7 syncer \u4ece\u5bbf\u4e3b\u96c6\u7fa4\u540c\u6b65\u5230\u865a\u62df\u96c6\u7fa4\u4e2d\u3002\\n- recover-vcluster \u4ee5 StatefulSet \u7684\u65b9\u5f0f\u90e8\u7f72\uff0c\u7528\u4e8e\u7ba1\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221004234534.png)\\n\\n### 5.1 \u6682\u505c\u865a\u62df\u96c6\u7fa4\\n\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u6682\u505c\u865a\u62df\u96c6\u7fa4\u3002\u4f1a\u5c06 vcluster \u7684 StatefulSet \u7684\u526f\u672c\u6570\u7f29\u51cf\u4e3a 0\uff0c\u5e76\u5220\u9664 vcluster \u521b\u5efa\u7684\u6240\u6709\u5de5\u4f5c\u8d1f\u8f7d\uff08\u672c\u793a\u4f8b\u4e2d\u662f coredns Pod\uff09\u3002\\n\\n```bash\\nkubectl config use-context <host-cluster-context>\\nvcluster pause recover-vcluster\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221004234640.png)\\n\\n### 5.2 \u6062\u590d\u865a\u62df\u96c6\u7fa4\\n\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u6062\u590d\u865a\u62df\u96c6\u7fa4\u3002\u4f1a\u5c06 vcluster \u7684 StatefulSet \u7684\u526f\u672c\u6570\u6062\u590d\u4e3a\u539f\u6837\uff0c\u5e76\u4e14 vcluster syncer \u5c06\u91cd\u65b0\u521b\u5efa\u76f8\u5e94\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002\\n\\n```bash\\nvcluster resume recover-vcluster\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221004234739.png)\\n\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n```bash\\nvcluster delete recover-vcluster\\n```\\n\\n## 6 \u5b58\u50a8\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221005000122.png)\\n\\n```bash\\n# sync-storage.yaml\\nvcluster create storage-vcluster -f sync-storage.yaml\\n```\\n\\n### 6.1 \u521b\u5efa StorageClass\\n```yaml\\n# sc.yaml\\napiVersion: storage.k8s.io/v1\\nkind: StorageClass\\nmetadata:\\n  name: my-local-hostpath\\n  annotations:\\n    openebs.io/cas-type: local\\n    cas.openebs.io/config: |\\n      - name: StorageType\\n        value: hostpath\\n      - name: BasePath\\n        value: /var/my-local-hostpath\\nprovisioner: openebs.io/local # \u6307\u5b9a OpenEBS \u4f5c\u4e3a\u6301\u4e45\u5377\u7684 Provisioner\\nreclaimPolicy: Delete\\nvolumeBindingMode: WaitForFirstConsumer\\n```\\n\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa StorageClass\u3002\\n```bash\\nkubectl config use-context <virtual-cluster-context>\\nkubectl apply -f sc.yaml\\n```\\n\\nvcluster \u4f1a\u5728\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u771f\u6b63\u7684 StorageClass\uff0c\u5c06 my-local-hostpath StorageClass \u4ee5\u67d0\u79cd\u683c\u5f0f\u8fdb\u884c\u91cd\u5199\u3002\\n\\n```bash\\nkubectl config use-context <host-cluster-context>\\nkubectl get sc | grep my-local-hostpath\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221005202932.png)\\n\\n### 6.2 \u521b\u5efa PersistentVolumeClaim\\n```yaml\\n# pvc-sc.yaml\\napiVersion: v1\\nkind: PersistentVolumeClaim\\nmetadata:\\n  name: my-persistent-volume-claim\\nspec:\\n  storageClassName: my-local-hostpath # \u6307\u5b9a StorageClass\\n  accessModes:\\n    - ReadWriteOnce\\n  resources:\\n    requests:\\n      storage: 1Gi\\n```\\n\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa PersistentVolumeClaim\u3002\\n```bash\\nkubectl config use-context <virtual-cluster-context>\\nkubectl apply -f pvc-sc.yaml\\n```\\n\\n\u7531\u4e8e\u6211\u4eec\u521b\u5efa\u7684 StorageClass \u5c06 `volumeBindingMode` \u53c2\u6570\u8bbe\u7f6e\u4e3a `WaitForFirstConsumer`\uff0c\u8868\u793a\u5f53 PVC \u88ab Pod \u4f7f\u7528\u65f6\uff0c\u624d\u89e6\u53d1 PV \u548c\u540e\u7aef\u5b58\u50a8\u7684\u521b\u5efa\uff0c\u540c\u65f6\u5b9e\u73b0 PVC/PV \u7684\u7ed1\u5b9a\uff0c\u7531\u4e8e\u5f53\u524d\u8fd8\u6ca1\u6709 Pod \u4f7f\u7528\u8be5 PVC\uff0c\u56e0\u6b64 PVC \u5f53\u524d\u5904\u4e8e Pending \u72b6\u6001\u3002\u5982\u679c\u8981\u8ba9 PVC \u7acb\u5373\u548c PV \u8fdb\u884c\u7ed1\u5b9a\uff0c\u53ef\u4ee5\u5728 StorageClass \u4e2d\u5c06 `volumeBindingMode` \u53c2\u6570\u8bbe\u7f6e\u4e3a `Immediate`\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221005203646.png)\\n\\n\\n\u67e5\u770b\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u771f\u6b63\u521b\u5efa\u7684 PVC\u3002\\n```bash\\nkubectl config use-context <host-cluster-context>\\nkubectl get pvc -n vcluster-storage-vcluster\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221005204240.png)\\n\\n\\n### 6.3 \u521b\u5efa Pod \u6d88\u8d39 PersistentVolumeClaim\\n```yaml\\n# pod-sc.yaml\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  name: my-pod\\nspec:\\n  containers:\\n    - name: my-pod\\n      image: nginx\\n      volumeMounts:\\n        - name: config\\n          mountPath: /usr/share/nginx/html\\n          subPath: html\\n  volumes:\\n    - name: config\\n      persistentVolumeClaim:\\n        claimName: my-persistent-volume-claim # \u6d88\u8d39 PVC\\n```\\n\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa Pod\u3002\\n```bash\\nkubectl config use-context <virtual-cluster-context>\\nkubectl apply -f pvc-sc.yaml\\n```\\n\\n\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u7684 Pod \u5df2\u7ecf\u6210\u529f Running\uff0c\u5e76\u4e14 PVC \u4e5f\u7ed1\u5b9a\u4e86 PV\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221005205314.png)\\n\\n\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n\\n```bash\\nvcluster delete storage-vcluster\\n```\\n\\n\\n## 7 \u9ad8\u53ef\u7528\\n\u7531\u4e8e\u56fd\u5185\u65e0\u6cd5\u76f4\u63a5\u62c9\u53bb gcr \u7684\u955c\u50cf\uff0c\u8fd9\u91cc\u6211\u63d0\u524d\u5c06\u76f8\u5173\u955c\u50cf\u62c9\u53d6\u5230\u6211\u7684 Docker Hub \u4e0a\uff0c\u5927\u5bb6\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\\n```yaml\\n# ha.yaml\\n\\n# Enable HA mode\\nenableHA: true\\n\\n# Scale up syncer replicas\\nsyncer:\\n  replicas: 3\\n\\n# Scale up etcd\\netcd:\\n  image: cr7258/k8s.gcr.io.etcd:3.5.4-0\\n  replicas: 3\\n  storage:\\n    # If this is disabled, vcluster will use an emptyDir instead\\n    # of a PersistentVolumeClaim\\n    persistence: false\\n    \\n# Scale up controller manager\\ncontroller:\\n  image: cr7258/k8s.gcr.io.kube-controller-manager:v1.25.0\\n  replicas: 3\\n\\n# Scale up api server\\napi:\\n  image: cr7258/k8s.gcr.io.kube-apiserver:v1.25.0\\n  replicas: 3\\n\\n# Scale up DNS server\\ncoredns:\\n  replicas: 3\\n```\\n\\n- `--connect=false` \u8868\u793a\u4e0d\u5207\u6362\u5230\u865a\u62df\u96c6\u7fa4\u6240\u5728\u7684 kubeconfig \u4e0a\u4e0b\u6587\u3002\\n- `--distro` \u53c2\u6570\u53ef\u4ee5\u6307\u5b9a\u521b\u5efa\u865a\u62df\u96c6\u7fa4\u4f7f\u7528\u7684 Kubernetes \u53d1\u884c\u7248\uff0c\u9ed8\u8ba4\u4f7f\u7528 K3S \u4f5c\u4e3a\u865a\u62df\u96c6\u7fa4\uff0c\u8fd9\u91cc\u6211\u4eec\u6307\u5b9a\u4f7f\u7528 Vanilla k8s \uff08\u666e\u901a\u7684 Kubernetes \u53d1\u884c\u7248\uff09\u6765\u90e8\u7f72\u865a\u62df\u96c6\u7fa4\u3002\\n```bash\\nvcluster create ha-vcluster --connect=false --distro k8s -f ha.yaml\\n```\\n\\n\u67e5\u770b\u521b\u5efa\u7684\u865a\u62df\u96c6\u7fa4\u63a7\u5236\u5e73\u9762 Pod\u3002\u53ef\u4ee5\u770b\u5230\u865a\u62df\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u90fd\u6709 3 \u4e2a\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221009180734.png)\\n\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n\\n```bash\\nvcluster delete ha-vcluster\\n```\\n\\n## 8 Pod \u8c03\u5ea6\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cvcluster \u5c06\u91cd\u7528\u4e3b\u673a\u96c6\u7fa4\u7684\u8c03\u5ea6\u7a0b\u5e8f\u6765\u8c03\u5ea6\u5de5\u4f5c\u8d1f\u8f7d\u3002\u8fd9\u6837\u53ef\u4ee5\u8282\u7701\u8ba1\u7b97\u8d44\u6e90\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u9650\u5236\uff1a\\n- 1.\u5728\u865a\u62df\u96c6\u7fa4\u5185\u6807\u8bb0\u8282\u70b9\u5bf9\u8c03\u5ea6\u6ca1\u6709\u5f71\u54cd\\n- 2.\u865a\u62df\u96c6\u7fa4\u5185\u7684\u6392\u7a7a\u6216\u6c61\u67d3\u8282\u70b9\u5bf9\u8c03\u5ea6\u6ca1\u6709\u5f71\u54cd\\n- 3.\u60a8\u4e0d\u80fd\u5728 vcluster \u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49\u8c03\u5ea6\u7a0b\u5e8f\\n\\n```yaml\\n# schedule.yaml\\nsync:\\n  nodes:\\n    enabled: true\\n    enableScheduler: true\\n    syncAllNodes: true\\n```\\n\\n```bash\\nvcluster create schedule-vcluster -f schedule.yaml\\n```\\n\\n\u67e5\u770b\u865a\u62df\u96c6\u7fa4\u7684\u8282\u70b9\u3002vcluster \u7684\u8282\u70b9\u6709\u4ee5\u4e0b\u51e0\u79cd\u6a21\u5f0f\uff1a\\n- **Fake Nodes**\\n- **Real Nodes**\\n- **Real Nodes All**\\n- **Real Nodes Label Selector**\\n```bash\\n> kubectl get node\\nNAME                             STATUS   ROLES    AGE   VERSION\\nip-192-168-29-123.ec2.internal   Ready    <none>   20m   v1.23.9-eks-ba74326\\nip-192-168-44-166.ec2.internal   Ready    <none>   20m   v1.23.9-eks-ba74326\\n```\\n\\n\u7ed9\u8282\u70b9 ip-192-168-44-166.ec2.internal \u6253\u4e0a\u6807\u7b7e `disktype=ssd`\u3002\\n```bash\\nkubectl label nodes ip-192-168-44-166.ec2.internal disktype=ssd\\n```\\n\\n\\n\u521b\u5efa Deployment\uff0c\u901a\u8fc7 nodeSelector \u53c2\u6570\u6839\u636e\u6807\u7b7e\u9009\u62e9\u8282\u70b9\uff0c\u5c06 6 \u4e2a Pod \u90fd\u5206\u914d\u5230\u8282\u70b9 ip-192-168-44-166.ec2.internal \u4e0a\u3002\\n```yaml\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\n  name: nginx-deployment\\n  labels:\\n    app: nginx\\nspec:\\n  replicas: 6\\n  selector:\\n    matchLabels:\\n      app: nginx\\n  template:\\n    metadata:\\n      labels:\\n        app: nginx\\n    spec:\\n      containers:\\n      - name: nginx\\n        image: nginx:1.14.2\\n        ports:\\n        - containerPort: 80\\n      nodeSelector:\\n        disktype: ssd\\n```\\n\\n\u67e5\u770b Pod \u7684\u5206\u5e03\u60c5\u51b5\uff0c\u53ef\u4ee5\u770b\u5230\u6240\u6709\u7684 Pod \u90fd\u8c03\u5ea6\u5230\u4e86\u8282\u70b9 ip-192-168-44-166.ec2.internal \u4e0a\u4e86\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221009183015.png)\\n\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n\\n```bash\\nvcluster delete schedule-vcluster\\n```\\n\\n## 9 \u9694\u79bb\u6a21\u5f0f\\n```bash\\nvcluster create isolate-vcluster --isolate\\n```\\n### 9.1 \u7f51\u7edc\u9694\u79bb\\n\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Pod\u3002\\n```bash\\nkubectl create deployment nettool-virtual --image=cr7258/nettool:v1\\n```\\n\u5728\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Pod\u3002\uff08\u5728\u5bbf\u4e3b\u96c6\u7fa4 context \u4e2d\u6267\u884c\uff09\\n```bash\\nkubectl config use-context <host-cluster-context>\\nkubectl create deployment nettool-host --image=cr7258/nettool:v1\\n```\\n\\n\u67e5\u770b\u5728\u865a\u62df\u96c6\u7fa4\u548c\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684 Pod \u7684 IP \u5730\u5740\u3002\uff08\u5728\u5bbf\u4e3b\u96c6\u7fa4 context \u4e2d\u6267\u884c\uff09\\n```bash\\nkubectl get pod -o wide\\nkubectl get pod -n vcluster-isolate-vcluster -o wide\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014191123.png)\\n\\n\u4e24\u4e2a Pod \u4e4b\u95f4\u4e92\u76f8 Ping \u6d4b\u8bd5\uff0c\u53ef\u4ee5\u770b\u5230\u865a\u62df\u96c6\u7fa4\u65e0\u6cd5\u901a\u8fc7 IP \u5730\u5740\u8bbf\u95ee\u5bbf\u4e3b\u96c6\u7fa4\uff0c\u4f46\u662f\u5bbf\u4e3b\u96c6\u7fa4\u53ef\u4ee5\u8bbf\u95ee\u865a\u62df\u96c6\u7fa4\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014191533.png)\\n\\n\u8ba9\u6211\u4eec\u770b\u770b\u5728\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684 NetworkPolicy\uff08\u5728\u865a\u62df\u96c6\u7fa4\u4e2d\u662f\u6ca1\u6709 NetworkPolicy \u7684\uff09\u3002\\n```bash\\nkubectl get networkpolicies -n vcluster-isolate-vcluster\\n```\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014193641.png)\\n\\n\u8fd9\u4e24\u6761 NetworkPolicy \u7684 YAML \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u770b\u5230 NetworkPolicy \u5bf9\u865a\u62df\u96c6\u7fa4\u7684 Egress \u65b9\u5411\u7684\u6d41\u91cf\u8fdb\u884c\u4e86\u9650\u5236\uff0c\u786e\u4fdd\u865a\u62df\u96c6\u7fa4\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u65e0\u6cd5\u4e3b\u52a8\u8bbf\u95ee\u5bbf\u4e3b\u96c6\u7fa4\u6216\u8005\u5176\u4ed6\u865a\u62df\u96c6\u7fa4\u3002\\n```yaml\\n# \u5141\u8bb8\u865a\u62df\u96c6\u7fa4\u7684\u63a7\u5236\u5e73\u9762\u8bbf\u95ee\u5bbf\u4e3b\u96c6\u7fa4\u4e2d\u7684 CoreDNS \u4ee5\u53ca API Server\\napiVersion: networking.k8s.io/v1\\nkind: NetworkPolicy\\nmetadata:\\n  annotations:\\n    meta.helm.sh/release-name: isolate-vcluster\\n    meta.helm.sh/release-namespace: vcluster-isolate-vcluster\\n  labels:\\n    app.kubernetes.io/managed-by: Helm\\n  name: isolate-vcluster-control-plane\\n  namespace: vcluster-isolate-vcluster\\nspec:\\n  egress:\\n  - ports:\\n    - port: 443\\n      protocol: TCP\\n    - port: 8443\\n      protocol: TCP\\n    - port: 6443\\n      protocol: TCP\\n  - to:\\n    - namespaceSelector:\\n        matchLabels:\\n          kubernetes.io/metadata.name: kube-system\\n      podSelector:\\n        matchLabels:\\n          k8s-app: kube-dns\\n  podSelector:\\n    matchLabels:\\n      release: isolate-vcluster\\n  policyTypes:\\n  - Egress\\n\\n# \u5141\u8bb8\u865a\u62df\u96c6\u7fa4\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8bbf\u95ee\u865a\u62df\u96c6\u7fa4\u7684\u63a7\u5236\u5e73\u9762\uff0c\u4ee5\u53ca\u516c\u7f51 IP\uff08ipBlock \u6392\u9664\u4e86\u5185\u7f51 IP\uff09\\napiVersion: networking.k8s.io/v1\\nkind: NetworkPolicy\\nmetadata:\\n  annotations:\\n    meta.helm.sh/release-name: isolate-vcluster\\n    meta.helm.sh/release-namespace: vcluster-isolate-vcluster\\n  labels:\\n    app.kubernetes.io/managed-by: Helm\\n  name: isolate-vcluster-workloads\\n  namespace: vcluster-isolate-vcluster\\nspec:\\n  egress:\\n  - ports:\\n    - port: 443\\n      protocol: TCP\\n    - port: 8443\\n      protocol: TCP\\n    to:\\n    - podSelector:\\n        matchLabels:\\n          release: isolate-vcluster\\n  - ports:\\n    - port: 53\\n      protocol: UDP\\n    - port: 53\\n      protocol: TCP\\n  - to:\\n    - podSelector:\\n        matchLabels:\\n          vcluster.loft.sh/managed-by: isolate-vcluster\\n    - ipBlock:\\n        cidr: 0.0.0.0/0\\n        except:\\n        - 100.64.0.0/10\\n        - 127.0.0.0/8\\n        - 10.0.0.0/8\\n        - 172.16.0.0/12\\n        - 192.168.0.0/16\\n  podSelector:\\n    matchLabels:\\n      vcluster.loft.sh/managed-by: isolate-vcluster\\n  policyTypes:\\n  - Egress\\n```\\n\\nhttps://orca.tufin.io/netpol/\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014192953.png)\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014193259.png)\\n\\n### 9.2 \u8d44\u6e90\u9650\u5236\\n\u540c\u65f6 vcluster \u4e5f\u4f1a\u5728\u865a\u62df\u96c6\u7fa4\u6240\u5728\u7684 Namespace \u521b\u5efa ResourceQuota \u548c LimitRange \u6765\u9650\u5236\u8d44\u6e90\u7684\u4f7f\u7528\u3002\\n- \u5176\u4e2d ResourceQuota \u7528\u4e8e\u63a7\u5236\u6574\u4e2a\u865a\u62df\u96c6\u7fa4\u6d88\u8017\u5bbf\u4e3b\u96c6\u7fa4\u7684\u8d44\u6e90\u4e0a\u9650\u3002\u9ed8\u8ba4\u521b\u5efa\u7684 ResourceQuota \u5982\u4e0b\u6240\u793a\uff0c\u9650\u5236\u4e86\u865a\u62df\u96c6\u7fa4\u6700\u591a\u521b\u5efa 100 \u4e2a Configmap\uff0c40 \u4e2a Endpoints\uff0c\u6700\u591a\u4f7f\u7528 40 Gi \u5185\u5b58\uff0c\u6700\u591a\u4f7f\u7528 10 \u6838 CPU \u7b49\u7b49...\\n```yaml\\napiVersion: v1\\nkind: ResourceQuota\\nmetadata:\\n  annotations:\\n    meta.helm.sh/release-name: isolate-vcluster\\n    meta.helm.sh/release-namespace: vcluster-isolate-vcluster\\n  labels:\\n    app.kubernetes.io/managed-by: Helm\\n  name: isolate-vcluster-quota\\n  namespace: vcluster-isolate-vcluster\\nspec:\\n  hard:\\n    count/configmaps: \\"100\\"\\n    count/endpoints: \\"40\\"\\n    count/persistentvolumeclaims: \\"20\\"\\n    count/pods: \\"20\\"\\n    count/secrets: \\"100\\"\\n    count/services: \\"20\\"\\n    limits.cpu: \\"20\\"\\n    limits.ephemeral-storage: 160Gi\\n    limits.memory: 40Gi\\n    requests.cpu: \\"10\\"\\n    requests.ephemeral-storage: 60Gi\\n    requests.memory: 20Gi\\n    requests.storage: 100Gi\\n    services.loadbalancers: \\"1\\"\\n    services.nodeports: \\"0\\"\\n```\\n- LimitRange \u7528\u4e8e\u63a7\u5236\u6bcf\u4e2a Pod \u7533\u8bf7\u8d44\u6e90\u7684\u4e0a\u9650\uff08\u5f53\u521b\u5efa\u7684 Pod \u6ca1\u6709\u6307\u5b9a `resources.requests`\xa0\u548c\xa0`resources.limits` \u53c2\u6570\u65f6\u4f1a\u5e94\u7528 LimitRange \u7684\u8bbe\u7f6e\uff09\u3002\u9ed8\u8ba4\u521b\u5efa\u7684 LimitRange \u5982\u4e0b\u6240\u793a\u3002\\n```yaml\\napiVersion: v1\\nkind: LimitRange\\nmetadata:\\n  annotations:\\n    meta.helm.sh/release-name: isolate-vcluster\\n    meta.helm.sh/release-namespace: vcluster-isolate-vcluster\\n  labels:\\n    app.kubernetes.io/managed-by: Helm\\n  name: isolate-vcluster-limit-range\\n  namespace: vcluster-isolate-vcluster\\nspec:\\n  limits:\\n  - default:\\n      cpu: \\"1\\"\\n      ephemeral-storage: 8Gi\\n      memory: 512Mi\\n    defaultRequest:\\n      cpu: 100m\\n      ephemeral-storage: 3Gi\\n      memory: 128Mi\\n    type: Container\\n```\\n\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\u865a\u62df\u96c6\u7fa4\u3002\\n\\n```bash\\nvcluster delete isolate-vcluster\\n```\\n\\n## 10 Cluster API Provider\\nhttps://github.com/loft-sh/cluster-api-provider-vcluster\\n\\n\u5b89\u88c5 vcluster provider\u3002\\n```bash\\nclusterctl init --infrastructure vcluster\\n```\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014225826.png)\\n\\n\u5c06\u4f1a\u90e8\u7f72\u4ee5\u4e0b\u8d44\u6e90\u3002\\n\\n![](https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20221014225922.png)\\n\\n\\n\u751f\u6210 vcluster \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5e76\u90e8\u7f72\u3002\\n```bash\\nexport CLUSTER_NAME=vcluster\\nexport CLUSTER_NAMESPACE=vcluster\\nexport KUBERNETES_VERSION=1.23.0\\nexport HELM_VALUES=\\"\\"\\n\\nkubectl create namespace ${CLUSTER_NAMESPACE}\\nclusterctl generate cluster ${CLUSTER_NAME} \\\\\\n    --infrastructure vcluster \\\\\\n    --kubernetes-version ${KUBERNETES_VERSION} \\\\\\n    --target-namespace ${CLUSTER_NAMESPACE} | kubectl apply -f -\\n```\\n\\n\u7b49\u5f85\u865a\u62df\u96c6\u7fa4\u521b\u5efa\u6210\u529f\u3002\\n```bash\\nkubectl wait --for=condition=ready vcluster -n $CLUSTER_NAMESPACE $CLUSTER_NAME --timeout=300s\\n```\\n\\n## 11 \u53c2\u8003\u8d44\u6599\\n- [1] [Install vcluster CLI: https://www.vcluster.com/docs/getting-started/setup\\n- [ ] https://www.vcluster.com/docs/getting-started/deployment"},{"id":"welcome","metadata":{"permalink":"/se7en-documentation/blog/welcome","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2021-08-26-welcome/index.md","source":"@site/blog/2021-08-26-welcome/index.md","title":"Welcome","description":"Docusaurus blogging features are powered by the blog plugin.","date":"2021-08-26T00:00:00.000Z","formattedDate":"August 26, 2021","tags":[{"label":"facebook","permalink":"/se7en-documentation/blog/tags/facebook"},{"label":"hello","permalink":"/se7en-documentation/blog/tags/hello"},{"label":"docusaurus","permalink":"/se7en-documentation/blog/tags/docusaurus"}],"readingTime":0.405,"hasTruncateMarker":false,"authors":[{"name":"S\xe9bastien Lorber","title":"Docusaurus maintainer","url":"https://sebastienlorber.com","imageURL":"https://github.com/slorber.png","key":"slorber"},{"name":"Yangshun Tay","title":"Front End Engineer @ Facebook","url":"https://github.com/yangshun","imageURL":"https://github.com/yangshun.png","key":"yangshun"}],"frontMatter":{"slug":"welcome","title":"Welcome","authors":["slorber","yangshun"],"tags":["facebook","hello","docusaurus"]},"prevItem":{"title":"vcluster","permalink":"/se7en-documentation/blog/2022/10/18/vcluster"},"nextItem":{"title":"MDX Blog Post","permalink":"/se7en-documentation/blog/mdx-blog-post"}},"content":"[Docusaurus blogging features](https://docusaurus.io/docs/blog) are powered by the [blog plugin](https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-blog).\\n\\nSimply add Markdown files (or folders) to the `blog` directory.\\n\\nRegular blog authors can be added to `authors.yml`.\\n\\nThe blog post date can be extracted from filenames, such as:\\n\\n- `2019-05-30-welcome.md`\\n- `2019-05-30-welcome/index.md`\\n\\nA blog post folder can be convenient to co-locate blog post images:\\n\\n![Docusaurus Plushie](./docusaurus-plushie-banner.jpeg)\\n\\nThe blog supports tags as well!\\n\\n**And if you don\'t want a blog**: just delete this directory, and use `blog: false` in your Docusaurus config."},{"id":"mdx-blog-post","metadata":{"permalink":"/se7en-documentation/blog/mdx-blog-post","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2021-08-01-mdx-blog-post.mdx","source":"@site/blog/2021-08-01-mdx-blog-post.mdx","title":"MDX Blog Post","description":"Blog posts support Docusaurus Markdown features, such as MDX.","date":"2021-08-01T00:00:00.000Z","formattedDate":"August 1, 2021","tags":[{"label":"docusaurus","permalink":"/se7en-documentation/blog/tags/docusaurus"}],"readingTime":0.175,"hasTruncateMarker":false,"authors":[{"name":"S\xe9bastien Lorber","title":"Docusaurus maintainer","url":"https://sebastienlorber.com","imageURL":"https://github.com/slorber.png","key":"slorber"}],"frontMatter":{"slug":"mdx-blog-post","title":"MDX Blog Post","authors":["slorber"],"tags":["docusaurus"]},"prevItem":{"title":"Welcome","permalink":"/se7en-documentation/blog/welcome"},"nextItem":{"title":"Long Blog Post","permalink":"/se7en-documentation/blog/long-blog-post"}},"content":"Blog posts support [Docusaurus Markdown features](https://docusaurus.io/docs/markdown-features), such as [MDX](https://mdxjs.com/).\\n\\n:::tip\\n\\nUse the power of React to create interactive blog posts.\\n\\n```js\\n<button onClick={() => alert(\'button clicked!\')}>Click me!</button>\\n```\\n\\n<button onClick={() => alert(\'button clicked!\')}>Click me!</button>\\n\\n:::"},{"id":"long-blog-post","metadata":{"permalink":"/se7en-documentation/blog/long-blog-post","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2019-05-29-long-blog-post.md","source":"@site/blog/2019-05-29-long-blog-post.md","title":"Long Blog Post","description":"This is the summary of a very long blog post,","date":"2019-05-29T00:00:00.000Z","formattedDate":"May 29, 2019","tags":[{"label":"hello","permalink":"/se7en-documentation/blog/tags/hello"},{"label":"docusaurus","permalink":"/se7en-documentation/blog/tags/docusaurus"}],"readingTime":2.05,"hasTruncateMarker":true,"authors":[{"name":"Endilie Yacop Sucipto","title":"Maintainer of Docusaurus","url":"https://github.com/endiliey","imageURL":"https://github.com/endiliey.png","key":"endi"}],"frontMatter":{"slug":"long-blog-post","title":"Long Blog Post","authors":"endi","tags":["hello","docusaurus"]},"prevItem":{"title":"MDX Blog Post","permalink":"/se7en-documentation/blog/mdx-blog-post"},"nextItem":{"title":"First Blog Post","permalink":"/se7en-documentation/blog/first-blog-post"}},"content":"This is the summary of a very long blog post,\\n\\nUse a `\x3c!--` `truncate` `--\x3e` comment to limit blog post size in the list view.\\n\\n\x3c!--truncate--\x3e\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet\\n\\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet"},{"id":"first-blog-post","metadata":{"permalink":"/se7en-documentation/blog/first-blog-post","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2019-05-28-first-blog-post.md","source":"@site/blog/2019-05-28-first-blog-post.md","title":"First Blog Post","description":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet","date":"2019-05-28T00:00:00.000Z","formattedDate":"May 28, 2019","tags":[{"label":"hola","permalink":"/se7en-documentation/blog/tags/hola"},{"label":"docusaurus","permalink":"/se7en-documentation/blog/tags/docusaurus"}],"readingTime":0.12,"hasTruncateMarker":false,"authors":[{"name":"Gao Wei","title":"Docusaurus Core Team","url":"https://github.com/wgao19","image_url":"https://github.com/wgao19.png","imageURL":"https://github.com/wgao19.png"}],"frontMatter":{"slug":"first-blog-post","title":"First Blog Post","authors":{"name":"Gao Wei","title":"Docusaurus Core Team","url":"https://github.com/wgao19","image_url":"https://github.com/wgao19.png","imageURL":"https://github.com/wgao19.png"},"tags":["hola","docusaurus"]},"prevItem":{"title":"Long Blog Post","permalink":"/se7en-documentation/blog/long-blog-post"}},"content":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum tempor eros aliquam consequat. Lorem ipsum dolor sit amet"}]}')}}]);